<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پک‌من - نسخه کلاسیک شفاف</title>
    <style>
        body { background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; color: #fff; font-family: 'Tahoma'; overflow: hidden; touch-action: none; }
        .hud { display: flex; gap: 40px; margin-bottom: 15px; background: #0a0a20; padding: 10px 30px; border-radius: 10px; border: 2px solid #1919A6; }
        .score-val { color: #ffff00; font-size: 24px; font-weight: bold; }
        canvas { border: 4px solid #1919A6; background: #000; image-rendering: pixelated; } /* شفافیت حداکثری پیکسل‌ها */
        .hint { color: #666; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="hud">
        <div style="text-align:center">امتیاز<br><span id="score" class="score-val">0</span></div>
        <div style="text-align:center">وضعیت<br><span id="status" style="color:#0f0">عادی</span></div>
    </div>

    <canvas id="gameCanvas" width="400" height="300"></canvas>
    <div class="hint">حرکت: کج کردن گوشی یا کلیدهای جهت‌نما</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const statusEl = document.getElementById('status');

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSfx(freq, type, dur, vol=0.05) {
            if (audioCtx.state !== 'running') return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + dur);
        }

        const tileSize = 20;
        let score = 0, gameOver = false, power = false, powerT = 0;
        let speed = 400; // همان سرعت ملایم درخواستی

        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,3,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,3,1],
            [1,0,1,1,0,1,0,1,1,1,1,1,1,0,1,0,1,1,0,1],
            [2,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,2],
            [1,0,1,1,0,1,1,1,0,1,1,0,1,1,1,0,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,1,0,0,1,1,1,1,0,1,1,0,1],
            [1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        let pacman = { x: 1, y: 3, dir: 'right', nextDir: 'right', mouth: 0 };
        let ghosts = [
            { x: 9, y: 5, color: '#FF0000' },
            { x: 10, y: 5, color: '#FFB8FF' }
        ];

        window.addEventListener('deviceorientation', (e) => {
            if (Math.abs(e.gamma) > 15) pacman.nextDir = e.gamma > 0 ? 'right' : 'left';
            else if (Math.abs(e.beta - 40) > 15) pacman.nextDir = e.beta > 40 ? 'down' : 'up';
        });

        function update() {
            if (gameOver) return;

            pacman.mouth = (pacman.mouth + 1) % 2;
            playSfx(pacman.mouth === 0 ? 250 : 200, 'triangle', 0.1);

            let nX = pacman.x, nY = pacman.y;
            if (pacman.nextDir === 'up') nY--; if (pacman.nextDir === 'down') nY++;
            if (pacman.nextDir === 'left') nX--; if (pacman.nextDir === 'right') nX++;

            if (map[nY] && map[nY][nX] !== 1) {
                pacman.dir = pacman.nextDir;
                pacman.x = nX; pacman.y = nY;
            } else {
                nX = pacman.x; nY = pacman.y;
                if (pacman.dir === 'up') nY--; if (pacman.dir === 'down') nY++;
                if (pacman.dir === 'left') nX--; if (pacman.dir === 'right') nX++;
                if (map[nY] && map[nY][nX] !== 1) { pacman.x = nX; pacman.y = nY; }
            }

            if (pacman.x < 0) pacman.x = 19; if (pacman.x > 19) pacman.x = 0;

            if (map[pacman.y][pacman.x] === 0) {
                map[pacman.y][pacman.x] = 2; score += 10;
                playSfx(800, 'sine', 0.05, 0.08);
            } else if (map[pacman.y][pacman.x] === 3) {
                map[pacman.y][pacman.x] = 2; score += 50;
                power = true; powerT = 30; statusEl.innerText = "قدرتمند!";
                playSfx(1200, 'square', 0.2);
            }

            ghosts.forEach(g => {
                if (Math.random() > 0.6) {
                    if (pacman.x > g.x) g.x++; else if (pacman.x < g.x) g.x--;
                    else if (pacman.y > g.y) g.y++; else if (pacman.y < g.y) g.y--;
                }
                if (pacman.x === g.x && pacman.y === g.y) {
                    if (power) { score += 200; g.x = 9; g.y = 5; playSfx(1000, 'square', 0.1); }
                    else { gameOver = true; playSfx(100, 'sawtooth', 0.5); }
                }
            });

            if (power) { powerT--; if(powerT <= 0) { power = false; statusEl.innerText = "عادی"; } }
            scoreEl.innerText = score;
        }

        function draw() {
            // حذف افکت شفافیت (پاک کردن کامل فریم قبلی)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let r = 0; r < map.length; r++) {
                for (let c = 0; c < map[r].length; c++) {
                    let x = c*tileSize, y = r*tileSize;
                    if (map[r][c] === 1) {
                        ctx.fillStyle = "#1919A6";
                        ctx.fillRect(x+1, y+1, tileSize-2, tileSize-2);
                    } else if (map[r][c] === 0) {
                        ctx.fillStyle = "#ffb8ae"; ctx.beginPath();
                        ctx.arc(x+10, y+10, 2, 0, 7); ctx.fill();
                    } else if (map[r][c] === 3) {
                        ctx.fillStyle = "#fff"; ctx.beginPath();
                        ctx.arc(x+10, y+10, 5, 0, 7); ctx.fill();
                    }
                }
            }

            // رسم پک‌من (بدون سایه و دنباله)
            ctx.fillStyle = "yellow";
            let rot = pacman.dir==='right'?0:pacman.dir==='down'?0.5:pacman.dir==='left'?1:1.5;
            let m = (pacman.mouth === 0) ? 0.2 : 0.05;
            ctx.beginPath();
            ctx.arc(pacman.x*20+10, pacman.y*20+10, 8, (m+rot)*Math.PI, (2-m+rot)*Math.PI);
            ctx.lineTo(pacman.x*20+10, pacman.y*20+10); ctx.fill();

            // روح‌ها (بدون سایه و دنباله)
            ghosts.forEach(g => {
                ctx.fillStyle = power ? "#00ffff" : g.color;
                ctx.beginPath(); ctx.arc(g.x*20+10, g.y*20+10, 8, Math.PI, 0);
                ctx.lineTo(g.x*20+18, g.y*20+18); ctx.lineTo(g.x*20+2, g.y*20+18); ctx.fill();
            });

            if (gameOver) {
                ctx.fillStyle = "white"; ctx.font = "20px Tahoma"; ctx.textAlign = "center";
                ctx.fillText("بازی تمام شد! کلیک کنید", 200, 150);
            }
        }

        window.addEventListener('keydown', e => {
            audioCtx.resume();
            if (e.key.includes('Arrow')) pacman.nextDir = e.key.replace('Arrow','').toLowerCase();
        });
        canvas.onclick = () => { if(gameOver) location.reload(); audioCtx.resume(); };

        function loop() { update(); draw(); setTimeout(loop, speed); }
        loop();
    </script>
</body>
</html>
