<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پک‌من تمام‌صفحه - موزیکال</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            background: #000; margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; width: 100vw; overflow: hidden; color: #fff; font-family: Tahoma;
        }
        #gameCanvas { 
            background: #000; touch-action: none;
            width: 100%; height: 100%; object-fit: contain;
        }
        .ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,100,0.6); padding: 5px 15px; border-radius: 20px; pointer-events: none; z-index: 10; border: 1px solid #1919A6; }
        .score-val { color: yellow; font-weight: bold; font-size: 20px; }
    </style>
</head>
<body>

    <div class="ui">امتیاز: <span id="score" class="score-val">0</span></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let musicStarted = false;

        // --- تولید موسیقی و صدا ---
        function playSfx(freq, type, dur, vol=0.05) {
            if (audioCtx.state !== 'running') return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + dur);
        }

        function startBackgroundMusic() {
            if (musicStarted) return;
            musicStarted = true;
            let note = 0;
            const melody = [110, 123, 130, 146, 110, 123, 130, 164]; // نوت‌های بیس کلاسیک
            setInterval(() => {
                if (!gameOver) {
                    playSfx(melody[note % melody.length], 'triangle', 0.4, 0.02);
                    note++;
                }
            }, 500);
        }

        // تنظیمات ابعاد
        const cols = 20, rows = 15;
        let tileSize;
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            tileSize = Math.min(canvas.width / cols, canvas.height / rows);
        }
        window.onresize = resize;
        resize();

        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,3,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,3,1],
            [1,0,1,1,0,1,0,1,1,1,1,1,1,0,1,0,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,0,0,0,0,1,1,1,0,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,0,1,1,1,2,2,1,1,1,0,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,0,1],
            [1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        let pacman = { x: 1, y: 3, dir: 'right', nextDir: 'right', mouth: 0 };
        let ghosts = [{ x: 9, y: 5, color: 'red' }, { x: 10, y: 5, color: 'pink' }];
        let score = 0, gameOver = false, power = false, powerT = 0;

        // --- سیستم کنترل سوایپ (Swipe) ---
        let touchStart = { x: 0, y: 0 };
        window.addEventListener('touchstart', e => {
            touchStart.x = e.touches[0].clientX;
            touchStart.y = e.touches[0].clientY;
            if (audioCtx.state !== 'running') audioCtx.resume().then(startBackgroundMusic);
        });

        window.addEventListener('touchend', e => {
            if (gameOver) { location.reload(); return; }
            let dx = e.changedTouches[0].clientX - touchStart.x;
            let dy = e.changedTouches[0].clientY - touchStart.y;
            
            if (Math.abs(dx) > Math.abs(dy)) {
                pacman.nextDir = dx > 0 ? 'right' : 'left';
            } else {
                pacman.nextDir = dy > 0 ? 'down' : 'up';
            }
        });

        // کنترل کیبورد
        window.addEventListener('keydown', e => {
            audioCtx.resume().then(startBackgroundMusic);
            if (e.key.includes('Arrow')) pacman.nextDir = e.key.replace('Arrow','').toLowerCase();
        });

        function update() {
            if (gameOver) return;

            pacman.mouth = (pacman.mouth + 1) % 2;
            if (pacman.mouth === 0) playSfx(250, 'triangle', 0.1, 0.02);

            let nX = pacman.x, nY = pacman.y;
            if (pacman.nextDir === 'up') nY--; if (pacman.nextDir === 'down') nY++;
            if (pacman.nextDir === 'left') nX--; if (pacman.nextDir === 'right') nX++;

            if (map[nY] && map[nY][nX] !== 1) {
                pacman.dir = pacman.nextDir; pacman.x = nX; pacman.y = nY;
            } else {
                nX = pacman.x; nY = pacman.y;
                if (pacman.dir === 'up') nY--; if (pacman.dir === 'down') nY++;
                if (pacman.dir === 'left') nX--; if (pacman.dir === 'right') nX++;
                if (map[nY] && map[nY][nX] !== 1) { pacman.x = nX; pacman.y = nY; }
            }

            if (pacman.x < 0) pacman.x = 19; if (pacman.x > 19) pacman.x = 0;

            if (map[pacman.y][pacman.x] === 0) {
                map[pacman.y][pacman.x] = 2; score += 10; playSfx(800, 'sine', 0.05);
            } else if (map[pacman.y][pacman.x] === 3) {
                map[pacman.y][pacman.x] = 2; score += 50; power = true; powerT = 30;
                playSfx(1200, 'square', 0.2);
            }

            ghosts.forEach(g => {
                if (Math.random() > 0.6) {
                    if (pacman.x > g.x) g.x++; else if (pacman.x < g.x) g.x--;
                    else if (pacman.y > g.y) g.y++; else if (pacman.y < g.y) g.y--;
                }
                if (pacman.x === g.x && pacman.y === g.y) {
                    if (power) { score += 200; g.x = 9; g.y = 5; }
                    else { gameOver = true; playSfx(100, 'sawtooth', 0.5); }
                }
            });
            if (power) { powerT--; if(powerT <= 0) power = false; }
            scoreEl.innerText = score;
        }

        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const offsetX = (canvas.width - cols * tileSize) / 2;
            const offsetY = (canvas.height - rows * tileSize) / 2;

            ctx.translate(offsetX, offsetY);
            for (let r = 0; r < map.length; r++) {
                for (let c = 0; c < map[r].length; c++) {
                    let x = c*tileSize, y = r*tileSize;
                    if (map[r][c] === 1) {
                        ctx.fillStyle = "#1919A6"; ctx.fillRect(x+1, y+1, tileSize-2, tileSize-2);
                    } else if (map[r][c] === 0) {
                        ctx.fillStyle = "#ffb8ae"; ctx.beginPath(); ctx.arc(x+tileSize/2, y+tileSize/2, 2, 0, 7); ctx.fill();
                    } else if (map[r][c] === 3) {
                        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(x+tileSize/2, y+tileSize/2, 5, 0, 7); ctx.fill();
                    }
                }
            }

            ctx.fillStyle = "yellow";
            let rot = pacman.dir==='right'?0:pacman.dir==='down'?0.5:pacman.dir==='left'?1:1.5;
            let m = (pacman.mouth === 0) ? 0.2 : 0.05;
            ctx.beginPath();
            ctx.arc(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2, tileSize/2.2, (m+rot)*Math.PI, (2-m+rot)*Math.PI);
            ctx.lineTo(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2); ctx.fill();

            ghosts.forEach(g => {
                ctx.fillStyle = power ? "#00ffff" : g.color;
                ctx.beginPath(); ctx.arc(g.x*tileSize+tileSize/2, g.y*tileSize+tileSize/2, tileSize/2.2, Math.PI, 0);
                ctx.lineTo(g.x*tileSize+tileSize-2, g.y*tileSize+tileSize-2); ctx.lineTo(g.x*tileSize+2, g.y*tileSize+tileSize-2); ctx.fill();
            });
            ctx.setTransform(1,0,0,1,0,0);

            if (gameOver) {
                ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = "white"; ctx.font = "30px Tahoma"; ctx.textAlign = "center";
                ctx.fillText("بازی تمام شد!", canvas.width/2, canvas.height/2);
                ctx.font = "20px Tahoma"; ctx.fillText("برای شروع مجدد ضربه بزنید", canvas.width/2, canvas.height/2 + 40);
            }
        }

        function loop() { update(); draw(); setTimeout(loop, 400); }
        loop();
    </script>
</body>
</html>
